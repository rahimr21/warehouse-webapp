{% extends "base.html" %}

{% block title %}New Box - Warehouse Management{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h1 class="mb-4">Create New Box</h1>
        
        <form method="POST" action="{{ url_for('new_box') }}">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="box_number" class="form-label">Box Number *</label>
                    <input type="text" class="form-control" id="box_number" name="box_number" value="{{ next_box_number }}" required>
                </div>
                <div class="col-md-4">
                    <label for="weight" class="form-label">Weight (lbs) *</label>
                    <input type="number" step="0.01" class="form-control" id="weight" name="weight" required>
                </div>
                <div class="col-md-4">
                    <label for="container_id" class="form-label">Assign to Container</label>
                    <select class="form-control" id="container_id" name="container_id">
                        <option value="">No Container</option>
                        {% for container in containers %}
                            <option value="{{ container.id }}">{{ container.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="box-type-section">
                <h5 class="mb-3">Box Type</h5>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="box_type" id="detailed" value="detailed" checked onchange="toggleBoxType()">
                    <label class="form-check-label" for="detailed">
                        Detailed (Bottom/Middle/Top sections)
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="box_type" id="simple" value="simple" onchange="toggleBoxType()">
                    <label class="form-check-label" for="simple">
                        Simple (Total quantities only)
                    </label>
                </div>
            </div>

            <div id="detailed-sections">
                {% for section in ['bottom', 'middle', 'top'] %}
                <div class="content-section">
                    <h5 class="mb-3">{{ section|title }} Section</h5>
                    <div id="{{ section }}-products">
                        <div class="product-row row">
                            <div class="col-md-4">
                                <select class="form-control product-select" name="{{ section }}_product[]" onchange="handleProductSelect(this)">
                                    <option value="">Select Product Type</option>
                                    <option value="Laptops">Laptops</option>
                                    <option value="PCs">PCs</option>
                                    <option value="LCDs">LCDs</option>
                                    <option value="Servers">Servers</option>
                                    <option value="Switches">Switches</option>
                                    <option value="Wires">Wires</option>
                                    <option value="Keyboards">Keyboards</option>
                                    <option value="Stands">Stands</option>
                                    <option value="Other">Other (specify)</option>
                                </select>
                                <input type="text" class="form-control mt-1 custom-product" name="{{ section }}_product[]" placeholder="Custom Product Type" style="display: none;">
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control" name="{{ section }}_quantity[]" placeholder="Quantity">
                            </div>
                            <div class="col-md-3">
                                <select class="form-control lcd-size-select" name="{{ section }}_lcd_size[]" style="display: none;" onchange="handleLcdSizeSelect(this)">
                                    <option value="">Select LCD Size</option>
                                    <option value="17&quot;S">17"S</option>
                                    <option value="17&quot;W">17"W</option>
                                    <option value="19&quot;S">19"S</option>
                                    <option value="19&quot;W">19"W</option>
                                    <option value="20&quot;S">20"S</option>
                                    <option value="20&quot;W">20"W</option>
                                    <option value="22&quot;">22"</option>
                                    <option value="23&quot;">23"</option>
                                    <option value="24&quot;">24"</option>
                                    <option value="Borderless 24&quot;">Borderless 24"</option>
                                    <option value="Custom">Custom Size</option>
                                </select>
                                <input type="text" class="form-control mt-1 custom-lcd-size" name="{{ section }}_lcd_size[]" placeholder="Custom LCD Size" style="display: none;">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-danger remove-row" onclick="removeRow(this)">×</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary mt-2" onclick="addProductRow('{{ section }}')">
                        Add Product
                    </button>
                </div>
                {% endfor %}
            </div>

            <div id="simple-section" class="simple-box-section" style="display: none;">
                <h5 class="mb-3">Product Contents</h5>
                <div id="simple-products">
                    <div class="product-row row">
                        <div class="col-md-4">
                            <select class="form-control product-select" name="simple_product[]" onchange="handleProductSelect(this)">
                                <option value="">Select Product Type</option>
                                <option value="Laptops">Laptops</option>
                                <option value="PCs">PCs</option>
                                <option value="LCDs">LCDs</option>
                                <option value="Servers">Servers</option>
                                <option value="Switches">Switches</option>
                                <option value="Wires">Wires</option>
                                <option value="Keyboards">Keyboards</option>
                                <option value="Stands">Stands</option>
                                <option value="Other">Other (specify)</option>
                            </select>
                            <input type="text" class="form-control mt-1 custom-product" name="simple_product[]" placeholder="Custom Product Type" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" name="simple_quantity[]" placeholder="Total Quantity">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control lcd-size-select" name="simple_lcd_size[]" style="display: none;" onchange="handleLcdSizeSelect(this)">
                                <option value="">Select LCD Size</option>
                                <option value="17&quot;S">17"S</option>
                                <option value="17&quot;W">17"W</option>
                                <option value="19&quot;S">19"S</option>
                                <option value="19&quot;W">19"W</option>
                                <option value="20&quot;S">20"S</option>
                                <option value="20&quot;W">20"W</option>
                                <option value="22&quot;">22"</option>
                                <option value="23&quot;">23"</option>
                                <option value="24&quot;">24"</option>
                                <option value="Borderless 24&quot;">Borderless 24"</option>
                                <option value="Custom">Custom Size</option>
                            </select>
                            <input type="text" class="form-control mt-1 custom-lcd-size" name="simple_lcd_size[]" placeholder="Custom LCD Size" style="display: none;">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger remove-row" onclick="removeRow(this)">×</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary mt-2" onclick="addSimpleProductRow()">
                    Add Product
                </button>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Create Box</button>
                <a href="{{ url_for('boxes') }}" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleBoxType() {
    const detailedSections = document.getElementById('detailed-sections');
    const simpleSection = document.getElementById('simple-section');
    const detailedRadio = document.getElementById('detailed');
    
    if (detailedRadio.checked) {
        detailedSections.style.display = 'block';
        simpleSection.style.display = 'none';
    } else {
        detailedSections.style.display = 'none';
        simpleSection.style.display = 'block';
    }
}

function handleProductSelect(select) {
    const row = select.closest('.product-row');
    const customInput = row.querySelector('.custom-product');
    const lcdSizeSelect = row.querySelector('.lcd-size-select');
    const customLcdSize = row.querySelector('.custom-lcd-size');
    
    // Handle custom product input
    if (select.value === 'Other') {
        customInput.style.display = 'block';
        customInput.required = true;
        // Clear the select value so the custom input will be used
        select.value = '';
    } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
    }
    
    // Handle LCD size input
    if (select.value === 'LCDs') {
        lcdSizeSelect.style.display = 'block';
        lcdSizeSelect.required = false; // Optional field
    } else {
        lcdSizeSelect.style.display = 'none';
        lcdSizeSelect.required = false;
        lcdSizeSelect.selectedIndex = 0;
        customLcdSize.style.display = 'none';
        customLcdSize.value = '';
    }
}

function handleLcdSizeSelect(select) {
    const row = select.closest('.product-row');
    const customLcdSize = row.querySelector('.custom-lcd-size');
    
    if (select.value === 'Custom') {
        customLcdSize.style.display = 'block';
        customLcdSize.required = true;
        // Clear the select value so the custom input will be used
        select.value = '';
    } else {
        customLcdSize.style.display = 'none';
        customLcdSize.required = false;
        customLcdSize.value = '';
    }
}

function addProductRow(section) {
    const container = document.getElementById(`${section}-products`);
    const newRow = document.createElement('div');
    newRow.className = 'product-row row';
    newRow.innerHTML = `
        <div class="col-md-4">
            <select class="form-control product-select" name="${section}_product[]" onchange="handleProductSelect(this)">
                <option value="">Select Product Type</option>
                <option value="Laptops">Laptops</option>
                <option value="PCs">PCs</option>
                <option value="LCDs">LCDs</option>
                <option value="Servers">Servers</option>
                <option value="Switches">Switches</option>
                <option value="Wires">Wires</option>
                <option value="Keyboards">Keyboards</option>
                <option value="Stands">Stands</option>
                <option value="Other">Other (specify)</option>
            </select>
            <input type="text" class="form-control mt-1 custom-product" name="${section}_product[]" placeholder="Custom Product Type" style="display: none;">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="${section}_quantity[]" placeholder="Quantity">
        </div>
        <div class="col-md-3">
            <select class="form-control lcd-size-select" name="${section}_lcd_size[]" style="display: none;" onchange="handleLcdSizeSelect(this)">
                <option value="">Select LCD Size</option>
                <option value="17&quot;S">17"S</option>
                <option value="17&quot;W">17"W</option>
                <option value="19&quot;S">19"S</option>
                <option value="19&quot;W">19"W</option>
                <option value="20&quot;S">20"S</option>
                <option value="20&quot;W">20"W</option>
                <option value="22&quot;">22"</option>
                <option value="23&quot;">23"</option>
                <option value="24&quot;">24"</option>
                <option value="Borderless 24&quot;">Borderless 24"</option>
                <option value="Custom">Custom Size</option>
            </select>
            <input type="text" class="form-control mt-1 custom-lcd-size" name="${section}_lcd_size[]" placeholder="Custom LCD Size" style="display: none;">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger remove-row" onclick="removeRow(this)">×</button>
        </div>
    `;
    container.appendChild(newRow);
}

function addSimpleProductRow() {
    const container = document.getElementById('simple-products');
    const newRow = document.createElement('div');
    newRow.className = 'product-row row';
    newRow.innerHTML = `
        <div class="col-md-4">
            <select class="form-control product-select" name="simple_product[]" onchange="handleProductSelect(this)">
                <option value="">Select Product Type</option>
                <option value="Laptops">Laptops</option>
                <option value="PCs">PCs</option>
                <option value="LCDs">LCDs</option>
                <option value="Servers">Servers</option>
                <option value="Switches">Switches</option>
                <option value="Wires">Wires</option>
                <option value="Keyboards">Keyboards</option>
                <option value="Stands">Stands</option>
                <option value="Other">Other (specify)</option>
            </select>
            <input type="text" class="form-control mt-1 custom-product" name="simple_product[]" placeholder="Custom Product Type" style="display: none;">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="simple_quantity[]" placeholder="Total Quantity">
        </div>
        <div class="col-md-3">
            <select class="form-control lcd-size-select" name="simple_lcd_size[]" style="display: none;" onchange="handleLcdSizeSelect(this)">
                <option value="">Select LCD Size</option>
                <option value="17&quot;S">17"S</option>
                <option value="17&quot;W">17"W</option>
                <option value="19&quot;S">19"S</option>
                <option value="19&quot;W">19"W</option>
                <option value="20&quot;S">20"S</option>
                <option value="20&quot;W">20"W</option>
                <option value="22&quot;">22"</option>
                <option value="23&quot;">23"</option>
                <option value="24&quot;">24"</option>
                <option value="Borderless 24&quot;">Borderless 24"</option>
                <option value="Custom">Custom Size</option>
            </select>
            <input type="text" class="form-control mt-1 custom-lcd-size" name="simple_lcd_size[]" placeholder="Custom LCD Size" style="display: none;">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger remove-row" onclick="removeRow(this)">×</button>
        </div>
    `;
    container.appendChild(newRow);
}

function removeRow(button) {
    const row = button.closest('.product-row');
    const container = row.parentElement;
    
    // Don't remove if it's the last row
    if (container.children.length > 1) {
        row.remove();
    } else {
        // Clear the inputs instead
        row.querySelectorAll('input, select').forEach(input => {
            if (input.tagName === 'SELECT') {
                input.selectedIndex = 0;
            } else {
                input.value = '';
            }
        });
        row.querySelectorAll('.custom-product').forEach(input => input.style.display = 'none');
    }
}

// Handle successful box creation - reset form and show success
document.addEventListener('DOMContentLoaded', function() {
    {% if box_created %}
    // Box was just created successfully
    const form = document.querySelector('form[method="POST"]');
    const boxNumberInput = document.getElementById('box_number');
    const weightInput = document.getElementById('weight');
    const containerSelect = document.getElementById('container_id');
    
    // Scroll to top to show success message
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Reset form after a short delay to let user see success message
    setTimeout(function() {
        // Reset box number to next suggested number
        if (boxNumberInput && '{{ next_box_number }}') {
            boxNumberInput.value = '{{ next_box_number }}';
        }
        
        // Clear weight
        if (weightInput) {
            weightInput.value = '';
        }
        
        // Reset container selection
        if (containerSelect) {
            containerSelect.selectedIndex = 0;
        }
        
        // Reset box type to detailed
        const detailedRadio = document.getElementById('detailed');
        if (detailedRadio) {
            detailedRadio.checked = true;
            toggleBoxType();
        }
        
        // Clear all product rows - keep only first row in each section
        ['bottom', 'middle', 'top'].forEach(function(section) {
            const container = document.getElementById(section + '-products');
            if (container && container.children.length > 1) {
                // Remove all but first row
                while (container.children.length > 1) {
                    container.removeChild(container.lastChild);
                }
                // Clear first row
                const firstRow = container.firstElementChild;
                if (firstRow) {
                    firstRow.querySelectorAll('input, select').forEach(function(input) {
                        if (input.tagName === 'SELECT') {
                            input.selectedIndex = 0;
                        } else {
                            input.value = '';
                        }
                    });
                    firstRow.querySelectorAll('.custom-product, .custom-lcd-size').forEach(function(input) {
                        input.style.display = 'none';
                        input.value = '';
                    });
                    firstRow.querySelectorAll('.lcd-size-select').forEach(function(select) {
                        select.style.display = 'none';
                        select.selectedIndex = 0;
                    });
                }
            }
        });
        
        // Clear simple section
        const simpleContainer = document.getElementById('simple-products');
        if (simpleContainer && simpleContainer.children.length > 1) {
            while (simpleContainer.children.length > 1) {
                simpleContainer.removeChild(simpleContainer.lastChild);
            }
            const firstRow = simpleContainer.firstElementChild;
            if (firstRow) {
                firstRow.querySelectorAll('input, select').forEach(function(input) {
                    if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0;
                    } else {
                        input.value = '';
                    }
                });
                firstRow.querySelectorAll('.custom-product, .custom-lcd-size').forEach(function(input) {
                    input.style.display = 'none';
                    input.value = '';
                });
                firstRow.querySelectorAll('.lcd-size-select').forEach(function(select) {
                    select.style.display = 'none';
                    select.selectedIndex = 0;
                });
            }
        }
        
        // Focus on box number input for next entry
        if (boxNumberInput) {
            boxNumberInput.focus();
        }
    }, 500);
    {% endif %}
});
</script>
{% endblock %} 